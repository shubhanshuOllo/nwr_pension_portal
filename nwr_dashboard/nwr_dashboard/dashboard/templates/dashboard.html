<!DOCTYPE html>
{% load static %}

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NWR Pension Portal</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link href="{% static '/css/style.css' %}" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <div class="loading-overlay" id="loading_div" style="display: none">
      <div class="loader"></div>
    </div>
    
    <div style="height: 100vh; display: flex ; flex-direction: column;">
    <nav class="navbar">
      <div class="logo-section">
        <img
          src="{% static 'images/rail_logo.png' %}"
          alt="Railway Logo"
          class="logo"
        />

          <h1 style="font-weight: 400;"><span style="color:#101828; font-weight: 500;">NWR</span> Pension Portal</h1>
      </div>
      <div class="nav-buttons">
        <a href="#" class="nav-button">
          <i class="fas fa-download"></i>
          NWR Master PPO
        </a>
        <a href="#" class="nav-button">
          <i class="fas fa-bank"></i>
          Bank's Master
        </a>
        <div class="profile-dropdown">
          <button class="profile-btn">
            <i class="fa-solid fa-user"></i>
          </button>
          <div class="dropdown-menu">
            <a href="/authentication/logout">Logout</a>
          </div>
        </div>
      </div>
    </nav>

    <div class="main-content">
      <!-- Left Column -->
      <div class="card">
        <div class="date-upload-container">
          <select
            class="dropdown"
            id="dateSelector"
            onchange="initializeNotificationHandlers()"
          >
            <option value="5">May</option>
            <option value="6">June</option>
            <option value="7">July</option>
            <option value="8">August</option>
            <option value="9">September</option>
          </select>
          <button class="upload-button">
            <i class="fas fa-upload"></i>
            Debit Scroll Upload
          </button>
        </div>
        <div class="chart-container">
          <canvas id="lineChart"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="pieChart"></canvas>
        </div>
        {% comment %} <div class="chart-container">
          <canvas id="linkedPieChart"></canvas>
        </div>

        <!-- Second Pie Chart: Matched Cases Breakdown -->
        <div class="chart-container">
          <canvas id="matchedPieChart"></canvas>
        </div> {% endcomment %}
      </div>

      <!-- Middle Column -->
      <div class="card middle-column" id="middleColumn">
        <!-- Content will be dynamically inserted here -->
        <div class="expandable-section">
          <div class="section-header">
            <div class="header-left">
              <span class="dot linked"></span>
              <h2>Matched Records</h2>
            </div>
          </div>
          <div class="section-content">
            <div class="linked-content">
              <div class="content-row">
                <span>Total Matched</span>
                <span class="matched-records">0</span>
              </div>
              <div class="content-row">
                <span>Total Unlinked</span>
                <span class="unlinked-records">0</span>
              </div>
            </div>
          </div>
        </div>

        <div class="expandable-section">
          <div class="section-header">
            <div class="header-left">
              <span class="dot unlinked"></span>
              <h2>Payment Analysis</h2>
            </div>
          </div>
          <div class="section-content">
            <div class="unlinked-content">
              <div class="content-row">
                <span>Overpayment Cases</span>
                <span class="overpayment-count">0</span>
              </div>
              <div class="content-row">
                <span>Overpayment Amount</span>
                <span class="overpayment-amount">â‚¹0</span>
              </div>
              <div class="content-row">
                <span>Underpayment Cases</span>
                <span class="underpayment-count">0</span>
              </div>
              <div class="content-row">
                <span>Underpayment Amount</span>
                <span class="underpayment-amount">â‚¹0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Chatbot -->
      <div class="chatbot">
        <!-- Rules and Functions Section -->
          <div class="rules-section" >
            <div class="rules-header" id="rulesSection">
            <h2>Rules and Functions</h2>
            <button class="toggle-button">
                <i class="fas fa-angle-down" style="color: white;"></i>
            </button>
          </div>
          <div class="rules-content">
            <div class="message-notifications">
              <div class="notification-item">
                <div class="notification-header">
                  <span>Overall underpayment/overpayment</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  Analyze and track payment discrepancies in pension
                  disbursements
                </p>
              </div>
              <div class="notification-item">
                <div class="notification-header">
                  <span>Age Metrics</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  View and analyze age-related pension metrics and statistics
                </p>
              </div>
              <div class="notification-item">
                <div class="notification-header">
                  <span>Family Pension Conversion</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  Track and manage family pension conversion cases
                </p>
              </div>
              {% comment %}
              <div class="notification-item">
                <div class="notification-header">
                  <span>Pay commission revisions</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  Monitor and implement pay commission revision updates
                </p>
              </div>
              {% endcomment %}
              <div class="notification-item">
                <div class="notification-header">
                  <span>New Pensioners</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  View and process new pension applications and cases
                </p>
              </div>
              <div class="notification-item">
                <div class="notification-header">
                  <span>Active Pensioner</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  View and process Active Pensioner applications and cases
                </p>
              </div>
              <div class="notification-item">
                <div class="notification-header">
                  <span>Enhanced Family Pension</span>
                  <span class="status-dot"></span>
                </div>
                <p class="notification-preview">
                  View and process Enhacned Family Pension applications and
                  cases
                </p>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-interface">
          <div class="chat-header">
            <h2>RailBot AI</h2>
            <div class="header-actions">
              <button class="action-button search">
                <i class="fas fa-search"></i>
              </button>
              <button class="action-button settings">
                <i class="fas fa-cog"></i>
              </button>
            </div>
          </div>
          <div class="chat-messages" id="chatMessages">
            <!-- Messages will be dynamically added here -->
          </div>
          <div class="chat-input-container">
            <div class="input-wrapper">
              <!-- <button class="attachment-button">
                            <i class="fas fa-paperclip"></i>
                        </button> -->
              <input
                type="text"
                placeholder="Message to RailBot..."
                id="chat_input"
                class="message-input"
              />
              <!-- <button class="emoji-button">
                            <i class="far fa-smile"></i>
                        </button> -->
            </div>
            <button class="send-button" onclick="submit_chat()">
              Send
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
            <div style=" display: flex; flex-direction: column; align-items: flex-end; margin-top: 6px; margin-bottom: 0px; ">
               <span style="background: linear-gradient(180deg, #292578 0%, #4C44DE 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; font-style: italic;  font-size: 14px;   padding-right: 4px;">Built by Degreemaster.ai</span>
               <div class="arrow_Degreemaster"></div>
        </div>
      </div>
    </div>
      </div>
      <!-- <div style="background: url(../../static/css/Indian_Railways_converted.png) no-repeat center; opacity: .1; background-size: contain; height: 100%; width: 100%; position: absolute; z-index: 1; left: 0px; right: 0; top: 0; bottom: 0; pointer-events: none;"> -->

      </div>
    </div>

    <!-- Add this HTML right before the chat input div for typing indicator -->
    <div class="typing-indicator" style="display: none">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>

    <!-- Modals -->
    <div id="debitScrollModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Upload Debit Scroll</h2>
          <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="file-upload-container">
          <input
            type="file"
            class="file-upload-input"
            accept=".xlsx,.xls,.csv"
          />
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click to upload or drag and drop</p>
          <p class="selected-file"></p>
        </div>
        <div class="modal-footer">
          <button class="modal-send-btn">
            <i class="fas fa-paper-plane"></i>
            Send File
          </button>
        </div>
      </div>
    </div>

    <div id="nwrMasterModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Upload NWR Master PPO</h2>
          <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="file-upload-container">
          <input
            type="file"
            class="file-upload-input"
            accept=".xlsx,.xls,.csv"
          />
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click to upload or drag and drop</p>
          <p class="selected-file"></p>
        </div>
        <div class="modal-footer">
          <button class="modal-send-btn">
            <i class="fas fa-paper-plane"></i>
            Send File
          </button>
        </div>
      </div>
    </div>

    <div id="bankMasterModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Upload Bank's Master</h2>
          <button class="modal-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="file-upload-container">
          <input
            type="file"
            class="file-upload-input"
            accept=".xlsx,.xls,.csv"
          />
          <i class="fas fa-cloud-upload-alt"></i>
          <p>Click to upload or drag and drop</p>
          <p class="selected-file"></p>
        </div>
        <div class="modal-footer">
          <button class="modal-send-btn">
            <i class="fas fa-paper-plane"></i>
            Send File
          </button>
        </div>
      </div>
    </div>

    <!-- Add this before the closing </body> tag -->
    <div class="loader-overlay">
      <div class="loader">
        <i class="fas fa-spinner fa-spin"></i>
        <p>Uploading file...</p>
      </div>
    </div>

    <script>
          let lineChart = null;
          let pieChart = null;
          let rule_data = null;

            // Function to initialize charts with default data
            {% comment %} function initializeDefaultCharts() {
                const defaultData = {
                    labels: ['Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb'],
                    lineData1: [35000, 65000, 22000, 25000, 58000, 30000],
                    lineData2: [20000, 30000, 52000, 40000, 15000, 45000],
                    pieData: [63, 25, 22]
                };

                const lineCtx = document.getElementById('lineChart').getContext('2d');
                const pieCtx = document.getElementById('pieChart').getContext('2d');

                // Destroy existing charts if they exist
                if (lineChart) {
                    lineChart.destroy();
                    lineChart = null;
                }
                if (pieChart) {
                    pieChart.destroy();
                    pieChart = null;
                }

                // Create line chart
                lineChart = new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: defaultData.labels,
                        datasets: [{
                            label: 'Overpayments (â‚¹)',
                            data: defaultData.lineData1,
                            borderColor: '#6B5EFF',
                            tension: 0.4,
                            fill: false
                        }, {
                            label: 'Underpayments (â‚¹)',
                            data: defaultData.lineData2,
                            borderColor: '#36A2EB',
                            tension: 0.4,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Month-over-Month Trends'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Amount (â‚¹)'
                                }
                            }
                        }
                    }
                });

                // Create pie chart
                pieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Overpayments', 'Underpayments', 'Not Found'],
                        datasets: [{
                            data: defaultData.pieData,
                            backgroundColor: [
                                '#6B5EFF',
                                '#36A2EB',
                                '#dbdbd9'
                            ],
                            borderColor: '#FFFFFF',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            title: {
                                display: true,
                                text: 'Payment Distribution'
                            }
                        }
                    }
                });
            } {% endcomment %}

          // Function to update charts with API data
          function updateChartsWithApiData(response) {
            try {
              if (!response.success || !response.data) {
                console.error("Invalid data format");
                return;
              }

                    const data = response.data;
                    const ruleData = data.rule_data;
                    const isRule1Format = ruleData.hasOwnProperty('matched_records');
                    const isRule3Format = ruleData.hasOwnProperty('regular_pension_count');
                    const isRule4Format = ruleData.hasOwnProperty('new');
                    const isRule5Format = ruleData.hasOwnProperty('stats');
                    const isRule6Format = ruleData.hasOwnProperty('count_of_active_pensioner');
                    const isRule7Format = ruleData.hasOwnProperty('efp_count');

              const lineCtx = document.getElementById("lineChart").getContext("2d");
              const pieCtx = document.getElementById("pieChart").getContext("2d");

              // Destroy existing charts
              if (lineChart) {
                lineChart.destroy();
                lineChart = null;
              }
              if (pieChart) {
                pieChart.destroy();
                pieChart = null;
              }

                    if (isRule4Format) {
                        // Rule 4: Create line chart for record trends
                        lineChart = new Chart(lineCtx, {
                            type: 'line',
                            data: {
                                labels: ['Revised', 'Not Revised', 'Unmatched', 'Total'],
                                datasets: [{
                                    label: 'Number of Records',
                                    data: [
                                        ruleData.new || 0,
                                        ruleData.old || 0,
                                        ruleData.unmatched || 0,
                                        ruleData.total || 0
                                    ],
                                    borderColor: '#6B5EFF',
                                    tension: 0.4,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Record Distribution'
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Number of Records'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        // Rule 4: Create pie chart for record distribution
                        pieChart = new Chart(pieCtx, {
                            type: 'pie',
                            data: {
                                labels: ['Revised', 'Not Revised'],
                                datasets: [{
                                    data: [
                                        ruleData.new || 0,
                                        ruleData.old || 0,
                                         ruleData.unmatched || 0
                                    ],
                                    backgroundColor: [
                                        '#6B5EFF',
                                        '#36A2EB',
                                        '#FF6384'
                                    ],
                                    borderColor: '#FFFFFF',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Record Type Distribution'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.raw || 0;
                                                const total = (ruleData.total || 0);
                                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                return `${value.toLocaleString()} records (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    } else if (isRule5Format) {
                        // ðŸ“Œ Rule 4: Monthly Pension Trends
                        const stats = ruleData.stats;
                        const months = Object.keys(stats).reverse();
                        const pensionCounts = months.map(month => stats[month].count);
                        const pensionAmounts = months.map(month => stats[month].total_pension);

                        // ðŸŽ¨ Create Line Chart for Monthly Pension Trends
                        lineChart = new Chart(lineCtx, {
                            type: 'line',
                            data: {
                                labels: months,
                                datasets: [
                                    {
                                        label: 'Number of Pensioners',
                                        data: pensionCounts,
                                        borderColor: '#6B5EFF',
                                        backgroundColor: 'rgba(107, 94, 255, 0.2)',
                                        tension: 0.4,
                                        fill: true
                                    },
                                    {
                                        label: 'Total Pension Amount (â‚¹)',
                                        data: pensionAmounts,
                                        borderColor: '#36A2EB',
                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                        tension: 0.4,
                                        fill: true,
                                        yAxisID: 'y1'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Monthly Pension Statistics'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.dataset.label || '';
                                                const value = context.raw;
                                                return label.includes('Amount') ? `${label}: â‚¹${value.toLocaleString()}` : `${label}: ${value.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Number of Pensioners'
                                        }
                                    },
                                    y1: {
                                        beginAtZero: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Pension Amount (â‚¹)'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        }
                                    }
                                }
                            }
                        });

                        // ðŸŽ¨ Create Pie Chart for Monthly Pension Distribution
                        pieChart = new Chart(pieCtx, {
                            type: 'pie',
                            data: {
                                labels: months,
                                datasets: [{
                                    data: pensionCounts,
                                    backgroundColor: ['#6B5EFF', '#36A2EB', '#FF6384', '#FFCD56'],
                                    borderColor: '#FFFFFF',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Monthly Pension Distribution'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.raw;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${value.toLocaleString()} pensioners (${percentage}%)`;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                    else if (isRule3Format) {
                        // Rule 3: Create line chart for pension distribution
                        lineChart = new Chart(lineCtx, {
                            type: 'line',
                            data: {
                                labels: ['Regular Pension', 'Family Pension'],
                                datasets: [{
                                    label: 'Number of Pensioners',
                                    data: [
                                        ruleData.regular_pension_count,
                                        ruleData.family_pension_count
                                    ],
                                    borderColor: '#6B5EFF',
                                    tension: 0.4,
                                    fill: false
                                }, {
                                    label: 'Pension Amount (â‚¹)',
                                    data: [
                                        ruleData.regular_pension_amount,
                                        ruleData.family_pension_amount
                                    ],
                                    borderColor: '#36A2EB',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Pension Type Distribution'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.dataset.label || '';
                                                const value = context.raw;
                                                if (label.includes('Amount')) {
                                                    return `${label}: â‚¹${value.toLocaleString()}`;
                                                }
                                                return `${label}: ${value.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Number of Pensioners'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    },
                                    y1: {
                                        beginAtZero: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Amount (â‚¹)'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return 'â‚¹' + value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });

                // Rule 3: Create pie chart for pension type distribution
                pieChart = new Chart(pieCtx, {
                  type: "pie",
                  data: {
                    labels: ["Regular Pension", "Family Pension"],
                    datasets: [
                      {
                        data: [
                          ruleData.regular_pension_count,
                          ruleData.family_pension_count,
                        ],
                        backgroundColor: ["#6B5EFF", "#36A2EB"],
                        borderColor: "#FFFFFF",
                        borderWidth: 2,
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        position: "bottom",
                      },
                      title: {
                        display: true,
                        text: "Distribution by Pension Type",
                      },
                      tooltip: {
                        callbacks: {
                          label: function (context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce(
                              (a, b) => a + b,
                              0
                            );
                            const percentage = ((value / total) * 100).toFixed(1);
                            const amount =
                              context.label === "Regular Pension"
                                ? ruleData.regular_pension_amount
                                : ruleData.family_pension_amount;
                            return [
                              `${value.toLocaleString()} pensioners (${percentage}%)`,
                              `Total Amount: â‚¹${amount.toLocaleString()}`,
                            ];
                          },
                        },
                      },
                    },
                  },
                });
              } else if (isRule1Format) {
                // Rule 1: Create line chart for payment trends
                lineChart = new Chart(lineCtx, {
                  type: "line",
                  data: {
                    labels: ["Matched", "Unmatched", "Overpayment", "Underpayment"],
                    datasets: [
                      {
                        label: "Number of Cases",
                        data: [
                          ruleData.matched_records,
                          ruleData.unlinked_records,
                          ruleData.overpayment_count,
                          ruleData.underpayment_count,
                        ],
                        borderColor: "#6B5EFF",
                        tension: 0.4,
                        fill: false,
                      },
                      {
                        label: "Amount (â‚¹)",
                        data: [
                          ruleData.linked_amount, // No amount for matched records
                          ruleData.unlinked_amount, // No amount for unlinked records
                          ruleData.overpayment_amount,
                          ruleData.underpayment_amount,
                        ],
                        borderColor: "#36A2EB",
                        tension: 0.4,
                        fill: false,
                        yAxisID: "y1",
                      },
                    ],
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      title: {
                        display: true,
                        text: "Payment Analysis Overview",
                      },
                      tooltip: {
                        callbacks: {
                          label: function (context) {
                            const label = context.dataset.label || "";
                            const value = context.raw;
                            if (label.includes("Amount")) {
                              return value > 0
                                ? `${label}: â‚¹${value.toLocaleString()}`
                                : "";
                            }
                            return `${label}: ${value.toLocaleString()}`;
                          },
                        },
                      },
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        title: {
                          display: true,
                          text: "Number of Cases",
                        },
                        ticks: {
                          callback: function (value) {
                            return value.toLocaleString();
                          },
                        },
                      },
                      y1: {
                        beginAtZero: true,
                        position: "right",
                        title: {
                          display: true,
                          text: "Amount (â‚¹)",
                        },
                        grid: {
                          drawOnChartArea: false,
                        },
                        ticks: {
                          callback: function (value) {
                            return "â‚¹" + value.toLocaleString();
                          },
                        },
                      },
                    },
                  },
                });

                pieChart = new Chart(pieCtx, {
                  type: "doughnut",
                  data: {
                      labels: [
                          "Unlinked Records",
                          "Linked - No Issue",
                          "Overpayment Cases",
                          "Underpayment Cases"
                      ],
                      datasets: [
                          // First Layer - Main Categories
                          /*{
                              data: [
                                  ruleData.unlinked_records, // Unlinked records
                                  ruleData.matched_records, // Total Matched records
                              ],
                              backgroundColor: ["#36A2EB", "#6B5EFF"], // Blue shades
                              borderColor: "#FFFFFF",
                              borderWidth: 2,
                          },*/
                          // Second Layer - Breakdown of Matched Records
                          {
                              data: [
                                  ruleData.unlinked_records, // Keep same as outer layer to align visually
                                  ruleData.matched_records - ruleData.overpayment_count - ruleData.underpayment_count, // Linked - No Issue
                                  ruleData.overpayment_count,
                                  ruleData.underpayment_count,
                              ],
                              backgroundColor: [
                                  "#E0E0E0",  // Light Grey for Unlinked (Neutral)
                                  "#4B49AC",  // Deep Indigo for Linked - No Issue
                                  "#F76C6C",  // Soft Red for Overpayment Cases
                                  "#2D9CDB"   // Bright Blue for Underpayment Cases
                              ],
                              borderColor: "#FFFFFF",
                              borderWidth: 2,
                          },
                      ],
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      cutout: "50%", // Adjust inner hole size for clarity
                      plugins: {
                          
                          legend: {
                              display: true, // Ensure legend is displayed
                              position: 'bottom', // Position legend at the bottom
                              labels: {
                                usePointStyle: true, // Use point style for legend
                                color: '#333', // Set legend text color
                              },
                          },
                          tooltip: {
                              callbacks: {
                                  label: function (context) {
                                      let datasetIndex = context.datasetIndex;
                                      let dataIndex = context.dataIndex;
                                      let value = context.raw;
                                      let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                      let percentage = ((value / total) * 100).toFixed(1);

                                      // Correct label for "Linked - No Issue"
                                      if (datasetIndex === 1 && dataIndex === 1) {
                                          return `Linked - No Issue: ${value.toLocaleString()} cases (${percentage}%)`;
                                      }

                                      return `${context.chart.data.labels[dataIndex]}: ${value.toLocaleString()} cases (${percentage}%)`;
                                  }
                              }
                          }
                      }
                  }
              });


                  } else if (isRule6Format) {

                          lineChart = new Chart(lineCtx, {
                              type: 'line',
                              data: {
                                  labels: ['Total Pensioners', 'Active Pensioners', 'Inactive Pensioners'],
                                  datasets: [{
                                      label: 'Number of Pensioners',
                                      data: [
                                          ruleData.total_pensioner || 0,
                                          ruleData.count_of_active_pensioner || 0,
                                          ruleData.count_of_un_active_pensioner || 0
                                      ],
                                      borderColor: '#6B5EFF',
                                      tension: 0.4,
                                      fill: false
                                  }]
                              },
                              options: {
                                  responsive: true,
                                  maintainAspectRatio: false,
                                  plugins: {
                                      title: {
                                          display: true,
                                          text: 'Pensioner Status Overview (Rule 6)'
                                      },
                                      tooltip: {
                                          callbacks: {
                                              label: function(context) {
                                                  const label = context.dataset.label || '';
                                                  const value = context.raw || 0;
                                                  return `${label}: ${value.toLocaleString()}`;
                                              }
                                          }
                                      }
                                  },
                                  scales: {
                                      y: {
                                          beginAtZero: true,
                                          title: {
                                              display: true,
                                              text: 'Number of Pensioners'
                                          },
                                          ticks: {
                                              callback: function(value) {
                                                  return value.toLocaleString();
                                              }
                                          }
                                      }
                                  }
                              }
                          });

                          pieChart = new Chart(pieCtx, {
                              type: 'doughnut',
                              data: {
                                  labels: ['Active Pensioners', 'Inactive Pensioners'],
                                  datasets: [{
                                      data: [
                                          ruleData.active_pensioner_amt || 0,
                                          ruleData.un_active_pensioner_amt || 0
                                      ],
                                      backgroundColor: ['#36A2EB', '#FF6384'],
                                      borderColor: '#FFFFFF',
                                      borderWidth: 2
                                  }]
                              },
                              options: {
                                  responsive: true,
                                  maintainAspectRatio: false,
                                  cutout: '50%',  // Adjust inner hole size for clarity
                                  plugins: {
                                      legend: {
                                          position: 'bottom'
                                      },
                                      tooltip: {
                                          callbacks: {
                                              label: function(context) {
                                                  let value = context.raw || 0;
                                                  let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                  let percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                                                  return `${value.toLocaleString()} amount (${percentage}%)`;
                                              }
                                          }
                                      }
                                  }
                              }
                          });

                  } else if (isRule7Format){
                      lineChart = new Chart(lineCtx, {
                          type: 'line',
                          data: {
                              labels: ['Total Pensioners', 'EFP Count', 'Normal Pension'],
                              datasets: [{
                                  label: 'Number of Cases',
                                  data: [
                                      ruleData.total_pensioner || 0,
                                      ruleData.efp_count || 0,
                                      ruleData.normal_pension || 0,

                                  ],
                                  borderColor: '#6B5EFF',
                                  tension: 0.4,
                                  fill: false
                              }]
                          },
                          options: {
                              responsive: true,
                              maintainAspectRatio: false,
                              plugins: {
                                  title: {
                                      display: true,
                                      text: 'Payment Analysis Overview (Rule 3)'
                                  },
                                  tooltip: {
                                      callbacks: {
                                          label: function(context) {
                                              const label = context.dataset.label || '';
                                              const value = context.raw || 0;
                                              return `${label}: ${value.toLocaleString()}`;
                                          }
                                      }
                                  }
                              },
                              scales: {
                                  y: {
                                      beginAtZero: true,
                                      title: {
                                          display: true,
                                          text: 'Number of Cases '
                                      },
                                      ticks: {
                                          callback: function(value) {
                                              return value.toLocaleString();
                                          }
                                      }
                                  }
                              }
                          }
                      });

                      pieChart = new Chart(pieCtx, {
                          type: 'doughnut',
                          data: {
                              labels: [ 'EFP Count', 'Normal Pension Count'],
                              datasets: [{
                                  data: [
                                     
                                      ruleData.efp_count || 0,
                                      ruleData.normal_pension || 0,

                                  ],
                                  backgroundColor: [ '#6B5EFF', '#FF6384'],
                                  borderColor: '#FFFFFF',
                                  borderWidth: 2
                              }]
                          },
                          options: {
                              responsive: true,
                              maintainAspectRatio: false,
                              cutout: '50%',
                              plugins: {
                                  legend: {
                                      position: 'bottom'
                                  },
                                  tooltip: {
                                      callbacks: {
                                          label: function(context) {
                                              let value = context.raw || 0;
                                              let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                              let percentage = total ? ((value / total) * 100).toFixed(1) : 0;
                                              return `${value.toLocaleString()} cases (${percentage}%)`;
                                          }
                                      }
                                  }
                              }
                          }
                      });
                  }
                  else {
                // Rule 2: Create line chart for age-wise distribution
                const ageRanges = Object.keys(ruleData).sort((a, b) => {
                  const aStart = parseInt(a.split("-")[0]);
                  const bStart = parseInt(b.split("-")[0]);
                  return aStart - bStart;
                });
                const pensionAmounts = ageRanges.map(
                  (range) => ruleData[range].pension
                );
                const pensionerCounts = ageRanges.map(
                  (range) => ruleData[range].count
                );

                        lineChart = new Chart(lineCtx, {
                            type: 'line',
                            data: {
                                labels: ageRanges.map(range => `${range} years`),
                                datasets: [{
                                    label: 'Pension Amount (â‚¹)',
                                    data: pensionAmounts,
                                    borderColor: '#6B5EFF',
                                    tension: 0.4,
                                    fill: false
                                }, {
                                    label: 'Number of Pensioners',
                                    data: pensionerCounts,
                                    borderColor: '#36A2EB',
                                    tension: 0.4,
                                    fill: false,
                                    yAxisID: 'y1'
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Age-wise Pension Distribution'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.dataset.label || '';
                                                const value = context.raw;
                                                if (label.includes('Amount')) {
                                                    return `${label}: â‚¹${value.toLocaleString()}`;
                                                }
                                                return `${label}: ${value.toLocaleString()}`;
                                            }
                                        }
                                    }
                                },
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Pension Amount (â‚¹)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return 'â‚¹' + value.toLocaleString();
                                            }
                                        }
                                    },
                                    y1: {
                                        beginAtZero: true,
                                        position: 'right',
                                        title: {
                                            display: true,
                                            text: 'Number of Pensioners'
                                        },
                                        grid: {
                                            drawOnChartArea: false
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toLocaleString();
                                            }
                                        }
                                    }
                                }
                            }
                        });

                        // Rule 2: Create pie chart for age distribution
                        pieChart = new Chart(pieCtx, {
                            type: 'pie',
                            data: {
                                labels: ageRanges.map(range => `${range} years`),
                                datasets: [{
                                    data: pensionerCounts,
                                    backgroundColor: [
                                        '#6B5EFF',
                                        '#36A2EB',
                                        '#4BC0C0',
                                        '#FFCD56',
                                        '#FF6384'
                                    ],
                                    borderColor: '#FFFFFF',
                                    borderWidth: 2
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: {
                                        position: 'bottom'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Distribution of Pensioners by Age'
                                    },
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const value = context.raw;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                const amount = ruleData[context.label.replace(' years', '')].pension;
                                                return [
                                                    `${value.toLocaleString()} pensioners (${percentage}%)`,
                                                    `Total Amount: â‚¹${amount.toLocaleString()}`
                                                ];
                                            }
                                        }
                                    }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error updating charts:', error);
                    {% comment %} initializeDefaultCharts(); {% endcomment %}
                }
            }

            // Function to update middle column data
            function updateMiddleColumn(response) {
                try {
                    if (!response.success || !response.data) {
                        console.error('Invalid data format for middle column');
                        return;
                    }

                    const data = response.data;
                    const ruleData = data.rule_data;
                    rule_data = ruleData;
                    const isRule1Format = ruleData.hasOwnProperty('matched_records');
                    const isRule3Format = ruleData.hasOwnProperty('regular_pension_count');
                    const isRule4Format = ruleData.hasOwnProperty('new');
                    const isRule5Format =  ruleData?.hasOwnProperty('stats');
                    const isRule6Format = ruleData.hasOwnProperty('count_of_active_pensioner');
                    const isRule7Format = ruleData.hasOwnProperty('efp_count');

                    // Create the appropriate middle column structure
                    createMiddleColumnContent(isRule1Format);

                    if (isRule4Format) {
                        // Update Record Summary section
                        const elements = {
                            newRecords: document.querySelector('.new-records'),
                            oldRecords: document.querySelector('.old-records'),
                            unmatchedRecords: document.querySelector('.unmatched-records'),
                            totalRecords: document.querySelector('.total-records')
                        };

                        if (elements.newRecords) {
                            elements.newRecords.textContent = (ruleData.new || 0).toLocaleString();
                        }
                        if (elements.oldRecords) {
                            elements.oldRecords.textContent = (ruleData.old || 0).toLocaleString();
                        }
                        if (elements.unmatchedRecords) {
                            elements.unmatchedRecords.textContent = (ruleData.unmatched || 0).toLocaleString();
                        }
                        if (elements.totalRecords) {
                            elements.totalRecords.textContent = (ruleData.total || 0).toLocaleString();
                        }
                    } else if (isRule3Format) {
                        // Update Regular Pension section
                        const regularPensionElement = document.querySelector('.regular-pension-count');
                        const regularPensionAmountElement = document.querySelector('.regular-pension-amount');

                        if (regularPensionElement) {
                            regularPensionElement.textContent = ruleData.regular_pension_count.toLocaleString();
                        }
                        if (regularPensionAmountElement) {
                            regularPensionAmountElement.textContent = `â‚¹${ruleData.regular_pension_amount.toLocaleString()}`;
                        }
                    } else if (isRule1Format) {
                        // Update Matched Records section
                        const matchedElement = document.querySelector('.matched-records');
                        const unlinkedElement = document.querySelector('.unlinked-records');

                        if (matchedElement) {
                            matchedElement.textContent = ruleData.matched_records.toLocaleString();
                        }
                        if (unlinkedElement) {
                            unlinkedElement.textContent = ruleData.unlinked_records.toLocaleString();
                        }

                        // Update Payment Analysis section
                        const elements = {
                            overpaymentCount: document.querySelector('.overpayment-count'),
                            overpaymentAmount: document.querySelector('.overpayment-amount'),
                            underpaymentCount: document.querySelector('.underpayment-count'),
                            underpaymentAmount: document.querySelector('.underpayment-amount')
                        };

                        if (elements.overpaymentCount) {
                            elements.overpaymentCount.textContent = ruleData.overpayment_count.toLocaleString();
                        }
                        if (elements.overpaymentAmount) {
                            elements.overpaymentAmount.textContent = `â‚¹${ruleData.overpayment_amount.toLocaleString()}`;
                        }
                        if (elements.underpaymentCount) {
                            elements.underpaymentCount.textContent = ruleData.underpayment_count.toLocaleString();
                        }
                        if (elements.underpaymentAmount) {
                            elements.underpaymentAmount.textContent = `â‚¹${ruleData.underpayment_amount.toLocaleString()}`;
                        }
                    } else if(isRule6Format){
                        const elements = {
                            totalPensioners: document.querySelector('.total-pensioners'),
                            activePensioners: document.querySelector('.active-pensioners'),
                            inactivePensioners: document.querySelector('.inactive-pensioners'),
                            activePensionerAmt: document.querySelector('.active-pensioner-amt'),
                            inactivePensionerAmt: document.querySelector('.inactive-pensioner-amt')
                        };

                        if (elements.totalPensioners) {
                            elements.totalPensioners.textContent = (ruleData.total_pensioner || 0).toLocaleString();
                        }
                        if (elements.activePensioners) {
                            elements.activePensioners.textContent = (ruleData.count_of_active_pensioner || 0).toLocaleString();
                        }
                        if (elements.inactivePensioners) {
                            elements.inactivePensioners.textContent = (ruleData.count_of_un_active_pensioner || 0).toLocaleString();
                        }
                        if (elements.activePensionerAmt) {
                            elements.activePensionerAmt.textContent = (ruleData.active_pensioner_amt || 0).toLocaleString();
                        }
                        if (elements.inactivePensionerAmt) {
                            elements.inactivePensionerAmt.textContent = (ruleData.un_active_pensioner_amt || 0).toLocaleString();
                        }
                    } else if(isRule7Format){
                        const elements = {
                            totalPensioners: document.querySelectorAll('.total-pensioners'),
                            efpCount: document.querySelectorAll('.efp-count'),
                            efpAmount: document.querySelectorAll('.efp-amt'),
                            normalPension: document.querySelectorAll('.normal-pension')
                        };

                        if (elements.totalPensioners) {
                            elements.totalPensioners.textContent = (ruleData.total_pensioner || 0).toLocaleString();
                        }
                        if (elements.efpCount) {
                            elements.efpCount.textContent = (ruleData.efp_count || 0).toLocaleString();
                        }
                        if (elements.normalPension) {
                            elements.normalPension.textContent = (ruleData.normal_pension || 0).toLocaleString();
                        }
                        if (elements.efpAmount) {
                            elements.efpAmount.textContent = (ruleData.efpAmount || 0).toLocaleString();
                        }
                    }
                    else {

                        const totalPensionElement = document.querySelector('.total-pension');
                        const totalAmountElement = document.querySelector('.total-amount');

                        if (totalPensionElement) {
                            totalPensionElement.textContent = data.total_pensioners.toLocaleString();
                        }
                        if (totalAmountElement) {
                            totalAmountElement.textContent = `â‚¹${data.total_amt.toLocaleString()}`;
                        }


                        const unlinkedContent = document.querySelector('.unlinked-content');
                        if (unlinkedContent) {
                            unlinkedContent.innerHTML = '';

                            const sortedRanges = Object.keys(ruleData).sort((a, b) => {
                                const aStart = parseInt(a.split('-')[0]);
                                const bStart = parseInt(b.split('-')[0]);
                                return aStart - bStart;
                            });

                            sortedRanges.forEach(ageRange => {
                                const rangeData = ruleData[ageRange];
                                const row = document.createElement('div');
                                row.className = 'content-row';
                                row.innerHTML = `
                                    <span>${ageRange} years</span>
                                    <div style="display: flex; gap: 1rem; align-items: center;">
                                        <span class="cases">${rangeData.count.toLocaleString()} cases</span>
                                        <span class="amount">â‚¹${rangeData.pension.toLocaleString()}</span>
                                    </div>
                                `;
                                unlinkedContent.appendChild(row);
                            });
                        }
                    }

              // Expand first section by default
              const firstSection = document.querySelector(".expandable-section");
              if (firstSection) {
                firstSection.classList.add("active");
                const content = firstSection.querySelector(".section-content");
                if (content) {
                  content.style.maxHeight = `${content.scrollHeight}px`;
                  content.style.opacity = "1";
                  content.style.padding = "6px 26px";
                  content.style.marginBottom = "26px";
                }
              }
            } catch (error) {
              console.error("Error updating middle column:", error);
            }
          }

          async function fetchRuleData(ruleId, month) {
            console.log("Fetching rule data:", ruleId, month);

            try {
              const response = await fetch(
                `/dashboard/get_rule/?month=${month}&rule=${ruleId}`,
                {
                  method: "GET",
                  headers: {
                    "Content-Type": "application/json",
                  },
                }
              );

              if (!response.ok) {
                throw new Error(
                  `Network response was not ok, status: ${response.status}`
                );
              }

              const data = await response.json();
              console.log("API Response:", data);
              return data;
            } catch (error) {
              console.error("Error fetching rule data:", error);
              return null;
            }
          }

            // Function to handle rule selection
            async function handleRuleSelection(ruleId, month) {
                try {
                    const response = await fetchRuleData(ruleId, month);
                    if (response && response.success) {
                        window.currentResponse = response; // Store the response
                        updateChartsWithApiData(response);
                        updateMiddleColumn(response);
                    } else {
                        console.log(1)
                        {% comment %} initializeDefaultCharts(); {% endcomment %}
                    }
                } catch (error) {
                    console.error('Error handling rule selection:', error);
                    {% comment %} initializeDefaultCharts(); {% endcomment %}
                }
            }

          // Function to handle file upload
          function handleFileUpload(file, modalType) {
            return new Promise(async (resolve, reject) => {
              try {
                const formData = new FormData();
                formData.append("file", file);

                let endpoint;
                switch (modalType) {
                  case "debitScrollModal":
                    endpoint = "/dashboard/upload_debit_zone";
                    break;
                  case "nwrMasterModal":
                    endpoint = "/dashboard/upload_master_excel";
                    break;
                  case "bankMasterModal":
                    endpoint = "/dashboard/upload_nwr_zone";
                    break;
                  default:
                    throw new Error("Unknown upload type");
                }

                const response = await fetch(endpoint, {
                  method: "POST",
                  body: formData,
                });

                if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                resolve(result);
              } catch (error) {
                reject(error);
              }
            });
          }

          // Function to initialize expandable sections
          function initializeExpandableSections() {
            const sections = document.querySelectorAll(".expandable-section");

            sections.forEach((section) => {
              const header = section.querySelector(".section-header");
              const content = section.querySelector(".section-content");

              // Set initial state
              content.style.maxHeight = "0px";
              content.style.opacity = "0";

              header.addEventListener("click", () => {
                // Toggle active class
                section.classList.toggle("active");

                // Update content visibility
                if (section.classList.contains("active")) {
                  content.style.maxHeight = `${content.scrollHeight}px`;
                  content.style.opacity = "1";
                  content.style.padding = "6px 26px";
                  content.style.marginBottom = "26px";
                } else {
                  content.style.maxHeight = "0px";
                  content.style.opacity = "0";
                  content.style.padding = "0px 26px";
                  content.style.marginBottom = "0px";
                }
              });
            });
          }

          // Initialize everything when the page loads
          function initializeApp() {
            // Initialize default charts
            initializeNotificationHandlers();
            {% comment %} initializeDefaultCharts(); {% endcomment %}

            // Initialize expandable sections
            initializeExpandableSections();

            // Add event listener for rule selection
            const ruleSelector = document.getElementById("ruleSelector");
            let dateSelector = document.getElementById("dateSelector");

            if (ruleSelector && dateSelector) {
              // Handle rule changes
              ruleSelector.addEventListener("change", (e) => {
                const selectedMonth = dateSelector.value || "9"; // Default to 9 if no month selected
                // handleRuleSelection(e.target.value, selectedMonth);
              });

              // Handle date changes
              dateSelector.addEventListener("change", (e) => {
                const selectedRule = ruleSelector.value || "1"; // Default to rule 1 if none selected
                // handleRuleSelection(selectedRule, e.target.value);
              });
            }
          }

          document.addEventListener("DOMContentLoaded", initializeApp);

            // Add this function to create middle column content
            function createMiddleColumnContent(isRule1Format) {
                const middleColumn = document.getElementById('middleColumn');
                const ruleData = window.currentResponse?.data?.rule_data;
                const ruleno = window.currentResponse?.data?.rule_no;
                const isRule3Format = ruleData?.hasOwnProperty('regular_pension_count');
                const isRule4Format = ruleData?.hasOwnProperty('new');
                const isRule5Format =  ruleData?.hasOwnProperty('stats');
                const isRule6Format = ruleData.hasOwnProperty('count_of_active_pensioner');
                const isRule7Format = ruleData.hasOwnProperty('efp_count');

                if (isRule4Format) {
                    // Rule 4 content
                    middleColumn.innerHTML = `
                        <div class="expandable-section">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot linked"></span>
                                    <h2>Record Summary</h2>
                                </div>

                            </div>
                            <div class="section-content">
                                <div class="linked-content">
                                    <div class="content-row">
                                        <span>Revised</span>
                                        <span class="new-records">${ruleData.new?.toLocaleString() || '0'}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Not Revised</span>
                                        <span class="old-records">${ruleData.old?.toLocaleString() || '0'}</span>
                                    </div>
                                    {% comment %} <div class="content-row">
                                        <span>Unmatched Records</span>
                                        <span class="unmatched-records">${ruleData.unmatched?.toLocaleString() || '0'}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Total Records</span>
                                        <span class="total-records">${ruleData.total?.toLocaleString() || '0'}</span>
                                    </div> {% endcomment %}
                                </div>
                            </div>
                        </div>

                        <div class="expandable-section active" >
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot unlinked"></span>
                                    <h2>Additional Information</h2>
                                </div>

                            </div>
                            <div class="section-content" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                                <div class="unlinked-content">
                                    <div class="content-row">
                                        <span>Unmatched Records</span>
                                        <span class="unmatched-records">${ruleData.unmatched.toLocaleString()}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Total Records</span>
                                        <span class="total-records">${ruleData.total.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (isRule3Format) {
                    // Existing Rule 3 content
                    middleColumn.innerHTML = `
                        <div class="expandable-section">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot linked"></span>
                                    <h2>Regular Pension</h2>
                                </div>

                            </div>
                            <div class="section-content" >
                                <div class="linked-content">
                                    <div class="content-row">
                                        <span>Total Pensioners</span>
                                        <span class="regular-pension-count">${ruleData.regular_pension_count.toLocaleString()}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Total Amount</span>
                                        <span class="regular-pension-amount">â‚¹${ruleData.regular_pension_amount.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="expandable-section active" >
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot unlinked"></span>
                                    <h2>Family Pension</h2>
                                </div>

                            </div>
                            <div class="section-content" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                                <div class="unlinked-content">
                                    <div class="content-row">
                                        <span>Total Pensioners</span>
                                        <span class="family-pension-count">${ruleData.family_pension_count.toLocaleString()}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Total Amount</span>
                                        <span class="family-pension-amount">â‚¹${ruleData.family_pension_amount.toLocaleString()}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if(isRule5Format){
                    middleColumn.innerHTML = `
                    <div class="expandable-section">
                <div class="section-header">
                    <div class="header-left">
                        <span class="dot linked"></span>
                        <h2>Number of Pensioners Added Each Month</h2>
                    </div>

                </div>
                <div class="section-content">
                    <div class="stats-content">
                        ${Object.keys(ruleData.stats).map(month => `
                            <div class="content-row">
                                <span>${month}</span>
                                <span >${ruleData.stats[month].count.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>

            <div class="expandable-section active" >
                <div class="section-header" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                    <div class="header-left">
                        <span class="dot unlinked"></span>
                        <h2>Total Pension Amount Added Each Month</h2>
                    </div>

                </div>
                <div class="section-content">
                    <div class="stats-content">
                        ${Object.keys(ruleData.stats).map(month => `
                            <div class="content-row">
                                <span>${month}</span>
                                <span >â‚¹${ruleData.stats[month].total_pension.toLocaleString()}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
                `;
                if  (ruleData.zone_change && ruleData.zone_change!=0){
                    middleColumn.innerHTML += `
                    <div class="expandable-section active">
                <div class="section-header">
                    <div class="header-left">
                        <span class="dot unlinked"></span>
                        <h2>Zone change to NWR</h2>
                    </div>

                </div>
                <div class="section-content">
                    <div class="stats-content">
                            <div class="content-row">
                                <span>Total no of zone change </span>
                                <span >${ruleData.zone_change.toLocaleString()}</span>
                            </div>
                    </div>
                </div>
            </div>
                    `;
                }

                }else if (isRule1Format) {
                    middleColumn.innerHTML = `
                        <div class="expandable-section">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot linked"></span>
                                    <h2>Matched Records</h2>
                                </div>
                                <button class="download-button" onclick="filedownload()" style="min-width: 45px;border-radius:11px ">
                                <i class="fas fa-download"></i>
                            </button>

                            </div>
                            <div class="section-content">
                                <div class="linked-content">
                                    <div class="content-row">
                                        <span>Total Matched</span>
                                        <span class="matched-records">0</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Total Unlinked</span>
                                        <span class="unlinked-records">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="expandable-section active">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot unlinked"></span>
                                    <h2>Payment Analysis</h2>
                                </div>

                            </div>
                            <div class="section-content" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                                <div class="unlinked-content">
                                    <div class="content-row">
                                        <span>Overpayment Cases</span>
                                        <span class="overpayment-count">0</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Overpayment Amount</span>
                                        <span class="overpayment-amount">â‚¹0</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Underpayment Cases</span>
                                        <span class="underpayment-count">0</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Underpayment Amount</span>
                                        <span class="underpayment-amount">â‚¹0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if(isRule6Format){
                    middleColumn.innerHTML = `
                        <div class="expandable-section">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot linked"></span>
                                    <h2>Record Summary</h2>
                                </div>

                            </div>
                            <div class="section-content">
                                <div class="linked-content">
                                    <div class="content-row">
                                        <span>Total Pensioners</span>
                                        <span class="total-pensioners">${ruleData.total_pensioner?.toLocaleString() || '0'}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Active Pensioners</span>
                                        <span class="active-pensioners">${ruleData.count_of_active_pensioner?.toLocaleString() || '0'}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Inactive Pensioners</span>
                                        <span class="inactive-pensioners">${ruleData.count_of_un_active_pensioner?.toLocaleString() || '0'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="expandable-section active">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot unlinked"></span>
                                    <h2>Payment Analysis</h2>
                                </div>

                            </div>
                            <div class="section-content" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                                <div class="unlinked-content">
                                    <div class="content-row">
                                        <span>Active Pension Amount</span>
                                        <span class="active-pension-amt">â‚¹${ruleData.active_pensioner_amt?.toLocaleString() || '0'}</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Inactive Pension Amount</span>
                                        <span class="inactive-pension-amt">â‚¹${ruleData.un_active_pensioner_amt?.toLocaleString() || '0'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else if(isRule7Format){
                        middleColumn.innerHTML = `
                            <div class="expandable-section">
                                <div class="section-header">
                                    <div class="header-left">
                                        <span class="dot linked"></span>
                                        <h2> Pensioners Summary</h2>
                                    </div>

                                </div>
                                <div class="section-content">
                                    <div class="linked-content">
                                        <div class="content-row">
                                            <span>Total Pensioners</span>
                                            <span class="total-pensioners">${ruleData.total_pensioner.toLocaleString()}</span>
                                        </div>

                                        <div class="content-row">
                                            <span>Normal Pension</span>
                                            <span class="normal-pension">${ruleData.normal_pension.toLocaleString()}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="expandable-section active">
                                <div class="section-header">
                                    <div class="header-left">
                                        <span class="dot unlinked"></span>
                                        <h2>Enhance Family Pension </h2>
                                    </div>

                                </div>
                                <div class="section-content" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                                    <div class="unlinked-content">
                                        <div class="content-row">
                                            <span>Enhance Family Pension Count</span>
                                            <span class="efp-count">${ruleData.efp_count.toLocaleString()}</span>
                                        </div>
                                        <div class="content-row">
                                            <span>Enhance Family Pension Amount</span>
                                            <span class="efp-amt">â‚¹${ruleData.efp_amt.toLocaleString()}</span>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        `;
                }
                else {
                    // Existing Rule 2 content
                    middleColumn.innerHTML = `
                        <div class="expandable-section">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot linked"></span>
                                    <h2>Total Summary</h2>
                                </div>

                            </div>
                            <div class="section-content">
                                <div class="linked-content">
                                    <div class="content-row">
                                        <span>Total Pensioners</span>
                                        <span class="total-pension">0</span>
                                    </div>
                                    <div class="content-row">
                                        <span>Total Amount</span>
                                        <span class="total-amount">â‚¹0</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="expandable-section active">
                            <div class="section-header">
                                <div class="header-left">
                                    <span class="dot unlinked"></span>
                                    <h2>Age-wise Distribution</h2>
                                </div>

                            </div>
                            <div class="section-content" style="max-height: 178px; opacity: 1; padding: 6px 26px; margin-bottom: 26px;">
                                <div class="unlinked-content">
                                    <!-- Age-wise data will be dynamically inserted here -->
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Reinitialize expandable sections
                {% comment %} initializeExpandableSections(); {% endcomment %}
            }

          // Add this after your existing script
          document.addEventListener("DOMContentLoaded", function () {
            // Get modal elements
            const debitScrollModal = document.getElementById("debitScrollModal");
            const nwrMasterModal = document.getElementById("nwrMasterModal");
            const bankMasterModal = document.getElementById("bankMasterModal");
            const uploadButton = document.querySelector(".upload-button");
            const nwrMasterBtn = document.querySelector(".nav-button:nth-child(1)");
            const bankMasterBtn = document.querySelector(
              ".nav-button:nth-child(2)"
            );
            const modalCloses = document.querySelectorAll(".modal-close");
            const fileInputs = document.querySelectorAll(".file-upload-input");
            const fileContainers = document.querySelectorAll(
              ".file-upload-container"
            );
            const selectedFiles = document.querySelectorAll(".selected-file");
            const sendButtons = document.querySelectorAll(".modal-send-btn");
            const loaderOverlay = document.querySelector(".loader-overlay");

            // Function to show modal
            function showModal(modal) {
              modal.style.display = "flex";
              document.body.style.overflow = "hidden";
            }

            // Function to hide modal
            function hideModal(modal) {
              modal.style.display = "none";
              document.body.style.overflow = "auto";
            }

            // Show modals on button click
            uploadButton.addEventListener("click", () =>
              showModal(debitScrollModal)
            );
            nwrMasterBtn.addEventListener("click", (e) => {
              e.preventDefault();
              showModal(nwrMasterModal);
            });
            bankMasterBtn.addEventListener("click", (e) => {
              e.preventDefault();
              showModal(bankMasterModal);
            });

            // Close modals
            modalCloses.forEach((closeBtn) => {
              closeBtn.addEventListener("click", () => {
                const modal = closeBtn.closest(".modal");
                hideModal(modal);
              });
            });

            // Close on outside click
            window.addEventListener("click", (e) => {
              if (e.target.classList.contains("modal")) {
                hideModal(e.target);
              }
            });

            // Handle drag and drop
            fileContainers.forEach((container, index) => {
              container.addEventListener("dragover", (e) => {
                e.preventDefault();
                container.classList.add("dragging");
              });

              container.addEventListener("dragleave", () => {
                container.classList.remove("dragging");
              });

              container.addEventListener("drop", (e) => {
                e.preventDefault();
                container.classList.remove("dragging");
                const file = e.dataTransfer.files[0];
                if (file) {
                  fileInputs[index].files = e.dataTransfer.files;
                  handleFileSelection(file, index);
                }
              });

              container.addEventListener("click", () => {
                fileInputs[index].click();
              });
            });

            function handleFileSelection(file, index) {
              if (file) {
                selectedFiles[index].textContent = `Selected file: ${file.name}`;
                selectedFiles[index].style.display = "block";
                sendButtons[index].classList.add("active");
              } else {
                selectedFiles[index].textContent = "";
                selectedFiles[index].style.display = "none";
                sendButtons[index].classList.remove("active");
              }
            }

            fileInputs.forEach((input, index) => {
              input.addEventListener("change", (e) => {
                const file = e.target.files[0];
                handleFileSelection(file, index);
              });
            });

            sendButtons.forEach((button, index) => {
              console.log(index);
              button.addEventListener("click", () => {
                const fileInput = fileInputs[index];
                const file = fileInput.files[0];
                if (!file) return;

                button.disabled = true;
                loaderOverlay.style.display = "flex";

                const formData = new FormData();
                formData.append("file", file);

                // Determine the endpoint based on the modal
                const endpoint =
                  index === 0
                    ? "/dashboard/upload_debit_zone/"
                    : index === 1
                    ? "/dashboard/upload_nwr_zone/"
                    : "/dashboard/upload_master_excel/";

                $.ajax({
                  url: endpoint,
                  type: "POST",
                  data: formData,
                  processData: false,
                  contentType: false,
                  success: function (response) {
                    // Success
                    alert("File uploaded successfully!");

                    // Reset the form
                    fileInput.value = "";
                    selectedFiles[index].textContent = "";
                    selectedFiles[index].style.display = "none";
                    button.classList.remove("active");

                    // Hide modal and loader
                    hideModal(button.closest(".modal"));
                    loaderOverlay.style.display = "none";
                  },
                  error: function () {
                    // Error
                    alert("Failed to upload file. Please try again.");
                    loaderOverlay.style.display = "none";
                  },
                  complete: function () {
                    // Re-enable button
                    button.disabled = false;
                    button.innerHTML =
                      '<i class="fas fa-paper-plane"></i> Send File';
                  },
                });
              });
            });
          });

          document.addEventListener("DOMContentLoaded", function () {
            const rulesSection = document.querySelector(".rules-section");
            const rulesSection_div = document.getElementById("rulesSection");

            rulesSection_div.addEventListener("click", function () {
              rulesSection.classList.toggle("open");
            });
          });

          // JSON data structure for rules and their corresponding questions/options
          const rulesData = {
            overpayment_underpayment: {
              title: "Overall underpayment/overpayment",
              initial_message:
                "I can help you analyze payment discrepancies. What specific aspect would you like to examine?",
              options: [
                {
                  text: "Check overpayment cases",
                  response:
                    "I'll analyze the overpayment cases. Would you like to:",
                  sub_options: [
                    "View total number of overpayment cases",
                    "Calculate total overpayment amount",
                    "Get detailed breakdown by department",
                  ],
                },
                {
                  text: "Check underpayment cases",
                  response:
                    "I'll help you review underpayment cases. Would you like to:",
                  sub_options: [
                    "View total number of underpayment cases",
                    "Calculate total underpayment amount",
                    "Get detailed breakdown by department",
                  ],
                },
                {
                  text: "Compare payment trends",
                  response:
                    "Let's analyze payment trends. What would you like to focus on?",
                  sub_options: [
                    "Monthly payment variations",
                    "Department-wise analysis",
                    "Year-over-year comparison",
                  ],
                },
              ],
            },
            age_metrics: {
              title: "Age Related Metrics",
              initial_message:
                "I can help you analyze age-related pension data. What would you like to know?",
              options: [
                {
                  text: "Age Distribution Analysis",
                  response:
                    "Let's analyze the age distribution. Would you like to:",
                  sub_options: [
                    "View age group breakdown",
                    "Check average age by department",
                    "Identify retirement-eligible employees",
                  ],
                },
                {
                  text: "Pension Amount by Age",
                  response:
                    "I'll help you analyze pension amounts by age. Would you like to:",
                  sub_options: [
                    "View average pension by age group",
                    "Compare pension trends across age ranges",
                    "Identify age-based anomalies",
                  ],
                },
              ],
            },
            family_pension: {
              title: "Family Pension Cases",
              initial_message:
                "I can assist with family pension related queries. What would you like to explore?",
              options: [
                {
                  text: "Family Pension Conversion",
                  response:
                    "Let's look at family pension conversions. Would you like to:",
                  sub_options: [
                    "View pending conversion cases",
                    "Check eligibility criteria",
                    "Review conversion timeline",
                  ],
                },
                {
                  text: "Beneficiary Analysis",
                  response:
                    "I'll help you analyze beneficiary data. Would you like to:",
                  sub_options: [
                    "View beneficiary demographics",
                    "Check payment distribution",
                    "Review relationship categories",
                  ],
                },
              ],
            },
            pay_commission: {
              title: "Pay Commission Implementation",
              initial_message:
                "I can help you with pay commission related information. What would you like to know?",
              options: [
                {
                  text: "Implementation Status",
                  response:
                    "Let's check the implementation status. Would you like to:",
                  sub_options: [
                    "View overall progress",
                    "Check department-wise status",
                    "Review pending cases",
                  ],
                },
                {
                  text: "Financial Impact",
                  response:
                    "I'll help you analyze the financial impact. Would you like to:",
                  sub_options: [
                    "View total cost implications",
                    "Check arrear calculations",
                    "Compare pre and post revision",
                  ],
                },
              ],
            },
            pension_revision: {
              title: "Pension Revision Cases",
              initial_message:
                "I can help you with pension revision analysis. What would you like to examine?",
              options: [
                {
                  text: "Revision Status",
                  response: "Let's analyze the revision status. Would you like to:",
                  sub_options: [
                    "View pending revisions",
                    "Check completed revisions",
                    "Review revision timeline",
                  ],
                },
                {
                  text: "Impact Analysis",
                  response:
                    "I'll help you analyze the revision impact. Would you like to:",
                  sub_options: [
                    "Calculate financial impact",
                    "View beneficiary distribution",
                    "Check department-wise status",
                  ],
                },
              ],
            },
          };

          document.addEventListener("DOMContentLoaded", function () {
            const rulesSection = document.querySelector(".rules-section");
            const toggleButton = document.querySelector(".toggle-button");
            const chatMessages = document.querySelector(".chat-messages");
            const messageInput = document.querySelector(".message-input");
            const sendButton = document.querySelector(".send-button");
            const notificationItems =
              document.querySelectorAll(".notification-item");

            // Set initial state to open
            rulesSection.classList.add("open");

            toggleButton.addEventListener("click", function () {
              rulesSection.classList.toggle("open");
            });

            // Add click event listeners to notification items
            notificationItems.forEach((item) => {
              item.addEventListener("click", function () {
                // Clear existing chat messages
                chatMessages.innerHTML = "";

                // Get the selected rule title and description
                const ruleTitle = this.querySelector(
                  ".notification-header span"
                ).textContent;
                const ruleDescription = this.querySelector(
                  ".notification-preview"
                ).textContent;

                // Find the corresponding rule data
                let ruleData;
                if (
                  ruleTitle.toLowerCase().includes("overpayment") ||
                  ruleTitle.toLowerCase().includes("underpayment")
                ) {
                  ruleData = rulesData.overpayment_underpayment;
                } else if (ruleTitle.toLowerCase().includes("family pension")) {
                  ruleData = rulesData.family_pension;
                } else if (ruleTitle.toLowerCase().includes("pay commission")) {
                  ruleData = rulesData.pay_commission;
                } else if (ruleTitle.toLowerCase().includes("new pensioners")) {
                  ruleData = rulesData.pension_revision;
                }

                // Add initial bot message with the selected rule info

                // Close the rules section after selection
                rulesSection.classList.remove("open");
              });
            });

            // Function to add options buttons
            function addOptions(options) {
              const optionsDiv = document.createElement("div");
              optionsDiv.className = "options-container";

              options.forEach((option) => {
                const button = document.createElement("button");
                button.className = "option-button";
                button.textContent = option.text;
                button.addEventListener("click", () => {
                  // Add user's selection as a message
                  addMessage(option.text, false);

                  // Add bot's response
                  setTimeout(() => {
                    if (option.response) {
                      addMessage(option.response, true);
                    }

                    // Add sub-options if they exist
                    if (option.sub_options && option.sub_options.length > 0) {
                      setTimeout(() => {
                        addOptions(option.sub_options.map((text) => ({ text })));
                      }, 500);
                    }
                  }, 500);
                });
                optionsDiv.appendChild(button);
              });

              chatMessages.appendChild(optionsDiv);
            }

            // Function to add a message to the chat
            function addMessage(text, isBot = false) {
              const messageDiv = document.createElement("div");
              messageDiv.className = `message ${
                isBot ? "bot-message" : "user-message"
              }`;

              const messageContent = document.createElement("div");
              messageContent.className = "message-content";

              const textP = document.createElement("p");
              textP.textContent = text;

              const timeSpan = document.createElement("span");
              timeSpan.className = "message-time";
              const now = new Date();
              timeSpan.textContent = `${now.getHours()}:${String(
                now.getMinutes()
              ).padStart(2, "0")}`;

              messageContent.appendChild(textP);
              messageContent.appendChild(timeSpan);
              messageDiv.appendChild(messageContent);
              chatMessages.appendChild(messageDiv);

              // Scroll to bottom
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Handle send button click
            sendButton.addEventListener("click", function () {
              const text = messageInput.value.trim();
              if (text) {
                addMessage(text, false);
                messageInput.value = "";
              }
            });

            // Handle enter key in input
            messageInput.addEventListener("keypress", function (e) {
              if (e.key === "Enter") {
                const text = this.value.trim();
                console.log(text);
                if (text) {
                  submit_chat();

                  this.value = "";
                }
              }
            });
          });

          // Function to handle rule or function selection
          async function handleRuleOrFunctionSelect(ruleId) {
            try {
              // Get selected month from dropdown
              const monthDropdown = document.getElementById("dateSelector");
              const selectedMonth = monthDropdown ? monthDropdown.value : "9";

              // Use the existing handleRuleSelection function with ruleId and month
              await handleRuleSelection(ruleId, selectedMonth);
            } catch (error) {
              console.error("Error in rule/function selection:", error);
            }
          }

          // Function to initialize notification item click handlers
          {% comment %} function initializeNotificationHandlers() {
              console.log("Notification handlers initialized.");
              const notificationItems = document.querySelectorAll('.notification-item');

              // Map of text content to rule IDs
              const ruleIdMap = {
                  'Overall underpayment/overpayment': '1',
                  'Age Metrics': '2',
                  'Family Pension Conversion': '3',
                  'Pay commission revisions': '4'
              };

                  notificationItems.forEach(item => {
                      item.addEventListener('click', () => {
                          // Remove active class from all items
                          notificationItems.forEach(i => i.classList.remove('active'));

                          // Add active class to clicked item
                          item.classList.add('active');

                          // Get the rule name from the header span
                          const headerSpan = item.querySelector('.notification-header span:first-child');
                          const ruleName = headerSpan.textContent.trim();

                          // Get the corresponding rule ID
                          const ruleId = ruleIdMap[ruleName];
                          if (ruleId) {
                              handleRuleOrFunctionSelect(ruleId);
                          }
                          else{
                              console.log(1)
                          }
                      });
                  });
          } {% endcomment %}

          function initializeNotificationHandlers() {
            console.log("Notification handlers initialized.");
            const notificationItems =
              document.querySelectorAll(".notification-item");
            const ruleIdMap = {
              "Overall underpayment/overpayment": "1",
              "Age Metrics": "2",
              "Family Pension Conversion": "3",
              "Pay commission revisions": "4",
              'Active Pensioner': '6',
              'Enhanced Family Pension': '7',
              'New Pensioners': '5',
            };

            function getRuleIdFromActiveItem() {
              const activeItem = document.querySelector(
                ".notification-item.active"
              );
              if (activeItem) {
                const headerSpan = activeItem.querySelector(
                  ".notification-header span:first-child"
                );
                const ruleName = headerSpan.textContent.trim();
                return ruleIdMap[ruleName] || "1";
              }
              return "1";
            }

            notificationItems.forEach((item) => {
              item.addEventListener("click", () => {
                notificationItems.forEach((i) => i.classList.remove("active"));

                item.classList.add("active");

                const headerSpan = item.querySelector(
                  ".notification-header span:first-child"
                );
                const ruleName = headerSpan.textContent.trim();

                const ruleId = ruleIdMap[ruleName] || "1";

                handleRuleOrFunctionSelect(ruleId);
              });
            });

            const finalRuleId = getRuleIdFromActiveItem();
            handleRuleOrFunctionSelect(finalRuleId);
          }

          // Function to add a message to the chat
          function addMessage(text, isBot = false) {
            const chatMessages = document.querySelector(".chat-messages");
            if (!chatMessages) return;

            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${
              isBot ? "bot-message" : "user-message"
            }`;

            const messageContent = document.createElement("div");
            messageContent.className = "message-content";

            const textP = document.createElement("p");
            textP.textContent = text;

            const timeSpan = document.createElement("span");
            timeSpan.className = "message-time";
            const now = new Date();
            timeSpan.textContent = `${now.getHours()}:${String(
              now.getMinutes()
            ).padStart(2, "0")}`;

            messageContent.appendChild(textP);
            messageContent.appendChild(timeSpan);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
          }
          function addMessageStreaming(text, isBot = false) {
            const chatMessages = document.querySelector(".chat-messages");
            if (!chatMessages) return;

            // Create message container
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${
              isBot ? "bot-message" : "user-message"
            }`;

            // Create message content container
            const messageContent = document.createElement("div");
            messageContent.className = "message-content";

            // Create paragraph for text
            const textP = document.createElement("p");
            textP.textContent = ""; // Initially empty for the typing effect

            // Create timestamp
            const timeSpan = document.createElement("span");
            timeSpan.className = "message-time";
            const now = new Date();
            timeSpan.textContent = `${now.getHours()}:${String(
              now.getMinutes()
            ).padStart(2, "0")}`;

            // Append elements
            messageContent.appendChild(textP);
            messageContent.appendChild(timeSpan);
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Typing effect: Stream characters one by one
            let i = 0;
            function typeCharacter() {
              if (i < text.length) {
                textP.textContent += text[i];
                i++;
                setTimeout(typeCharacter, 30); // Adjust speed here (30ms per character)
              }
            }

            typeCharacter();
          }

          // Function to add options to the chat
          function addOptions(options) {
            const chatMessages = document.querySelector(".chat-messages");
            if (!chatMessages) return;

            const optionsDiv = document.createElement("div");
            optionsDiv.className = "options-container";

            options.forEach((option) => {
              const button = document.createElement("button");
              button.className = "option-button";
              button.textContent = option.text;
              button.addEventListener("click", () => {
                // Add user's selection as a message
                addMessage(option.text, false);

                // Add bot's response
                setTimeout(() => {
                  if (option.response) {
                    addMessage(option.response, true);
                  }

                  // Add sub-options if they exist
                  if (option.subOptions && option.subOptions.length > 0) {
                    setTimeout(() => {
                      addOptions(option.subOptions);
                    }, 500);
                  }
                }, 500);
              });
              optionsDiv.appendChild(button);
            });

            chatMessages.appendChild(optionsDiv);
          }

          // Function to get options based on rule ID

          // Handle send button click
          const sendButton = document.querySelector(".send-button");
          const messageInput = document.querySelector(".message-input");

          if (sendButton && messageInput) {
            sendButton.addEventListener("click", () => {
              const text = messageInput.value.trim();
              if (text) {
                addMessage(text, false);
                messageInput.value = "";
              }
            });

            // Handle enter key in input
            messageInput.addEventListener("keypress", (e) => {
              if (e.key === "Enter") {
                const text = messageInput.value.trim();
                if (text) {
                  submit_chat();

                  messageInput.value = "";
                }
              }
            });
          }
          function submit_chat() {
            const chatInput = document.getElementById("chat_input");
            const userQuery = chatInput.value.trim();

            if (!userQuery) return; // Prevent empty submissions

            addMessage(userQuery, false); // Show user message instantly

            const url = "/dashboard/chat_completion/";
            const xhr = new XMLHttpRequest();

            xhr.open("POST", url, true);
            xhr.setRequestHeader("Content-Type", "application/json");

            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                  let result;
                  try {
                    result = JSON.parse(xhr.responseText);
                    console.log("Result:", result);
                  } catch (error) {
                    console.error("Invalid JSON response:", xhr.responseText);
                    addMessage("Error: Invalid response format.", true);
                    return;
                  }

                  processResponse(result);
                } else {
                  console.error("Error:", xhr.responseText);
                  addMessage("An error occurred while fetching data.", true);
                }
              }
            };

            xhr.send(JSON.stringify({ query: userQuery }));
            chatInput.value = ""; // Clear input after sending
          }
          function processResponse(result) {
            if (!result || !result.data) {
              addMessageStreaming("No data received.", true);
              return;
            }

            const responseData = result.data;

            if (typeof responseData === "string") {
              // Handle direct text responses
              addMessageStreaming(responseData, true);
            } else if (Array.isArray(responseData)) {
              // Handle array responses
              responseData.forEach((entry) => {
                if (typeof entry === "string") {
                  addMessageStreaming(entry, true); // Handle string array
                } else if (typeof entry === "object") {
                  addMessageStreaming(formatObject(entry), true); // Handle object array
                }
              });
            } else if (typeof responseData === "object") {
              // Handle single object response
              addMessageStreaming(formatObject(responseData), true);
            } else {
              // Handle unknown response type
              addMessageStreaming("Unexpected response format.", true);
            }
          }

          // Format object to readable string
          function formatObject(obj) {
            return Object.entries(obj)
              .map(([key, value]) => `${key.replace(/_/g, " ")}: ${value}`)
              .join("\n");
          }
          function filedownload(){
            month = document.getElementById('dateSelector').value;
            var loading_div = document.getElementById("loading_div");
                loading_div.style.display = 'flex'
            $.ajax({
                type:'GET',
                data:{"rule_data":JSON.stringify(window.currentResponse.data.rule_data),"month":month},
                url:'/dashboard/download/',
                xhrFields: {
                    responseType: 'blob'  // Receive binary data
                },
                success:function(blob, status, xhr){
                    loading_div.style.display = 'none'
                    let filename = "sample_data.xlsx";  // Default filename
                    let downloadLink = document.createElement("a");
                    let url = window.URL.createObjectURL(blob);
                    downloadLink.href = url;
                    downloadLink.download = filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    window.URL.revokeObjectURL(url);
                },
                error: function(xhr, status, error) {
                    loading_div.style.display = 'none'
                    alert("Error downloading file: " + error);
                }

            })
        }
        function handleProfileAction(select) {
          const value = select.value;
          if (value) {
              window.location.href = value;  // Redirect on selection
          }
      }
      document.querySelector(".profile-btn").addEventListener("click", function () {
          document.querySelector(".profile-dropdown").classList.toggle("active");
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
          const dropdown = document.querySelector(".profile-dropdown");
          if (!dropdown.contains(event.target)) {
              dropdown.classList.remove("active");
          }
      });
    </script>
  </body>
</html>
